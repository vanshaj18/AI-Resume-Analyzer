<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resume Analyzer</title>
  {% load static %}
  <link rel="stylesheet" href="{% static 'ui/styles.css' %}" />
</head>
<body data-backend-url="{{ backend_url }}">
  <div class="shell">
    <header class="header">
      <div>
        <div class="eyebrow">Intelligence Suite</div>
        <h1>Resume Analyzer <span class="badge">v2.0</span></h1>
        <p class="sub">Advanced Semantic, Technical, and Psychometric profiling.</p>
      </div>
      <div class="header-actions">
        <a class="btn ghost" href="/analytics/" data-loading-text="Loading...">
          <span class="btn-label">View Analytics</span>
        </a>
      </div>
    </header>

    {% if error %}
      <div class="card error" style="border-left: 4px solid #ef4444;">
        <strong>Analysis Error:</strong> {{ error }}
      </div>
    {% endif %}

    <form class="grid-layout" method="post" enctype="multipart/form-data">
      {% csrf_token %}
      
      <aside class="side-col">
        <section class="card settings-card">
          <div class="card-header">
            <h2>Job Context</h2>
            <p class="sub">Optional guidance for shortlisting decisions.</p>
          </div>
          
          <div class="stack">

            <label class="field">
              <span>Company Name</span>
              {{ form.company_name }}
            </label>

            <label class="field">
              <span>Role</span>
              {{ form.role }}
            </label>

            <label class="field">
              <span>Experience Level (Years)</span>
              <div class="range-container">
                {{ form.experience_level }}
                <output id="experienceValue">3</output>
              </div>
            </label>

            <label class="field">
              <span>Job Description</span>
              {{ form.job_description }}
            </label>

            <label class="field">
              <span>Skills</span>
              {{ form.jd_prompt }}
              <p class="hint" id="jdPromptPreview"></p>
            </label>

          </div>

          <div class="settings-footer">
            <p class="hint">Parallel processing enabled for batch uploads.</p>
          </div>
        </section>
        </aside>

        <main class="main-col">
        <section class="card settings-card">
          <div class="card-header">
            <h2>Global AI Settings</h2>
            <p class="sub">Configurations apply to all runs</p>
          </div>
          <div class="stack">
            <label class="field">
              <span>Model Provider</span>
              {{ form.provider }}
            </label>

            <label class="field">
              <span>Intelligence Model</span>
              {{ form.ai_model }}
            </label>
            
            <label class="field">
              <span>Temperature (Creativity)</span>
              {{ form.temperature }}
            </label>
            
            <label class="field">
              <span>Confidence Threshold</span>
              <div class="range-container">
                {{ form.threshold }}
                <output id="thresholdValue">50</output>
              </div>
            </label>
          </div>
          <div class="actions">
            <button class="btn" type="button" id="saveAiSettings" data-loading-text="Saving...">
              <span class="btn-label">Save AI Settings</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
            <span class="hint" id="aiSettingsStatus">Not saved</span>
          </div>
        </section>

        <div class="mode-toggle">
          <button type="button" class="mode-btn active" data-mode="single">Single Analysis</button>
          <button type="button" class="mode-btn" data-mode="batch">Batch Upload</button>
        </div>

        <div id="singleSection" class="input-mode">
          <section class="card">
            <div class="card-header">
              <h2>Document Text</h2>
              <p class="sub">Paste resume content or technical bio</p>
            </div>
            <label class="field">
              {{ form.document_text }}
            </label>
            <button class="btn primary-btn" type="submit" data-loading-text="Running...">
              <span class="btn-label">Run Single Analysis</span>
              <span class="btn-spinner" aria-hidden="true"></span>
            </button>
          </section>
        </div>

        <div id="batchSection" class="input-mode hidden">
          <section class="card">
            <div class="card-header">
              <h2>Bulk Processing</h2>
              <p class="sub">PDFs are processed in parallel based on global settings</p>
            </div>
            
            <div class="upload-grid">
              <label class="upload-dropzone">
                <span>Upload Files</span>
                <input id="batchFiles" type="file" multiple accept=".pdf" />
              </label>
              <label class="upload-dropzone">
                <span>Upload Folder</span>
                <input id="batchFolder" type="file" webkitdirectory directory />
              </label>
            </div>

            <div class="actions">
              <button class="btn" type="button" id="batchRun">Run Batch Analysis</button>
              <button class="btn ghost" type="button" id="batchClear">Clear Queue</button>
            </div>
            
            <div class="progress-container">
              <div class="progress-bar-bg"><div class="progress-bar-fill" id="batchProgress"></div></div>
              <div class="status-legend">
                <span class="legend-item">Queued</span>
                <span class="legend-item">Running</span>
                <span class="legend-item">Done</span>
              </div>
              <div id="batchStatus" class="status-list"></div>
            </div>
          </section>
        </div>

        {% if result or resume_data %}
          <section class="card results-card">
            <div class="card-header">
              <h2>Analysis Result</h2>
              <p class="sub">Summary and score from the latest run</p>
            </div>
            {% if result %}
              <div class="result-grid">
                <div class="stat-card">
                  <h3>Score</h3>
                  <div class="stat-value">{{ result.score }}</div>
                </div>
                <div class="stat-card">
                  <h3>Summary</h3>
                  <p class="result-text">{{ result.summary }}</p>
                </div>
              </div>
            {% else %}
              <p class="result-text">No result available.</p>
            {% endif %}
          </section>
        {% endif %}
      </main>
    </form>

    <section id="batchMode" class="card hidden">
      <div class="card-header">
        <h2>Batch Processing</h2>
        <p class="sub">Drag and drop multiple PDFs or entire folders for parallel processing.</p>
      </div>
      
      <div class="upload-zone">
        <div class="grid">
          <label class="upload-box">
            <span>Select Files</span>
            <input id="batchFiles" type="file" multiple accept=".pdf,application/pdf" />
          </label>
          <label class="upload-box">
            <span>Select Folder</span>
            <input id="batchFolder" type="file" webkitdirectory directory />
          </label>
        </div>
      </div>

      <div class="actions" style="margin-top: 1.5rem;">
        <button class="btn" type="button" id="batchRun" data-loading-text="Processing...">
          <span class="btn-label">Launch Batch Analysis</span>
          <span class="btn-spinner" aria-hidden="true"></span>
        </button>
        <button class="btn ghost" type="button" id="batchClear">Reset Queue</button>
      </div>

      <div class="progress-container">
        <div class="progress-bar-bg">
          <div class="progress-bar-fill" id="batchProgress"></div>
        </div>
        <div class="status-list" id="batchStatus"></div>
      </div>
    </section>
  </div>

  <footer class="waterfall-footer">
    <div class="waterfall-waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" fill="rgba(37, 99, 235, 0.7" />
          <use xlink:href="#gentle-wave" x="48" y="3" fill="rgba(37, 99, 235, 0.5)" />
          <use xlink:href="#gentle-wave" x="48" y="5" fill="rgba(37, 99, 235, 0.3)" />
          <use xlink:href="#gentle-wave" x="48" y="7" fill="#2563eb" />
        </g>
      </svg>
    </div>
    
    <div class="footer-content">
      <div class="footer-info">
        <p>&copy; 2026 AI Resume Analyzer â€¢ Intelligent Talent Profiling</p>
        <div class="footer-links">
          <a href="#">Privacy Policy</a>
          <a href="/technical-docs/">Technical Docs</a>
          <a href="#">Support</a>
        </div>
      </div>
    </div>
  </footer>

  {{ ai_model_providers|json_script:"providerModelsData" }}

  <script>
    const providerModels = JSON.parse(
      document.getElementById("providerModelsData")?.textContent || "{}"
    );
    document.querySelectorAll('.mode-btn').forEach(button => {
      button.addEventListener('click', function() {
        // UI state
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('active'));
        this.classList.add('active');
        
        // Section visibility
        const mode = this.dataset.mode;
        if (mode === 'single') {
          document.getElementById('singleSection').classList.remove('hidden');
          document.getElementById('batchSection').classList.add('hidden');
        } else {
          document.getElementById('singleSection').classList.add('hidden');
          document.getElementById('batchSection').classList.remove('hidden');
        }
      });
    });

    // Update threshold output
    const thresholdInput = document.querySelector('input[name="threshold"]');
    if (thresholdInput) {
      thresholdInput.addEventListener('input', (e) => {
        document.getElementById('thresholdValue').textContent = e.target.value;
      });
    }

    const slider = document.querySelector('input[name="threshold"]');
    const output = document.getElementById('thresholdValue');
    if (slider && output) {
      output.textContent = slider.value;
      slider.addEventListener('input', (e) => {
        output.textContent = e.target.value;
      });
    }

    const experienceSlider = document.querySelector('input[name="experience_level"]');
    const experienceOutput = document.getElementById('experienceValue');
    if (experienceSlider && experienceOutput) {
      experienceOutput.textContent = experienceSlider.value;
      experienceSlider.addEventListener('input', (e) => {
        experienceOutput.textContent = e.target.value;
      });
    }

    const form = document.querySelector('form.grid-layout');

    const linkButtons = document.querySelectorAll('a.btn[data-loading-text]');
    linkButtons.forEach((link) => {
      link.addEventListener('click', () => {
        link.classList.add('is-loading');
        link.setAttribute('aria-busy', 'true');
        const label = link.querySelector('.btn-label');
        const loadingText = link.getAttribute('data-loading-text');
        if (label && loadingText) {
          label.textContent = loadingText;
        }
      });
    });

    const backendUrl = document.body.dataset.backendUrl || "http://localhost:8001";
    const batchFilesInput = document.getElementById("batchFiles");
    const batchFolderInput = document.getElementById("batchFolder");
    const batchRun = document.getElementById("batchRun");
    const batchClear = document.getElementById("batchClear");
    const batchProgress = document.getElementById("batchProgress");
    const batchStatus = document.getElementById("batchStatus");
    const saveAiSettingsButton = document.getElementById("saveAiSettings");
    const aiSettingsStatus = document.getElementById("aiSettingsStatus");

    const uploadState = new Map();
    let savedAiSettings = null;
    let settingsDirty = false;

    const providerSelect = document.querySelector('select[name="provider"]');
    const modelSelect = document.querySelector('select[name="ai_model"]');
    const tempInputEl = document.querySelector('input[name="temperature"]');
    const thresholdInputEl = document.querySelector('input[name="threshold"]');

    const setRunEnabled = (enabled) => {
      if (batchRun) batchRun.disabled = !enabled;
      const submitBtn = form?.querySelector('button[type="submit"]');
      if (submitBtn) submitBtn.disabled = !enabled;
    };

    const markSettingsDirty = () => {
      settingsDirty = true;
      if (aiSettingsStatus) aiSettingsStatus.textContent = "Not saved";
      setRunEnabled(false);
    };

    const markSettingsSaved = () => {
      settingsDirty = false;
      if (aiSettingsStatus) aiSettingsStatus.textContent = "Saved";
      setRunEnabled(true);
    };
    const renderModelOptions = (provider) => {
      if (!modelSelect) return;
      const models = providerModels[provider] || providerModels.groq || [];
      modelSelect.innerHTML = "";
      models.forEach((item) => {
        const opt = document.createElement("option");
        opt.value = item[0];
        opt.textContent = item[1];
        modelSelect.appendChild(opt);
      });
      modelSelect.value = models[0]?.[0] || "";
    };

    if (providerSelect) {
      renderModelOptions(providerSelect.value || "groq");
      providerSelect.addEventListener("change", (e) => {
        renderModelOptions(e.target.value);
        markSettingsDirty();
      });
    }

    const formatBytes = (bytes) => {
      if (!bytes && bytes !== 0) return "";
      const units = ["B", "KB", "MB", "GB"];
      let value = bytes;
      let idx = 0;
      while (value >= 1024 && idx < units.length - 1) {
        value /= 1024;
        idx += 1;
      }
      return `${value.toFixed(value < 10 && idx > 0 ? 1 : 0)} ${units[idx]}`;
    };

    const collectFiles = () => {
      const files = [];
      if (batchFilesInput?.files?.length) {
        files.push(...batchFilesInput.files);
      }
      if (batchFolderInput?.files?.length) {
        files.push(...batchFolderInput.files);
      }
      const seen = new Set();
      return files.filter((file) => {
        const pathName = file.webkitRelativePath || file.name;
        const key = `${pathName}-${file.size}-${file.lastModified}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      });
    };

    const resetBatchUI = () => {
      uploadState.clear();
      if (batchStatus) batchStatus.innerHTML = "";
      if (batchProgress) batchProgress.style.width = "0%";
      if (batchFilesInput) batchFilesInput.value = "";
      if (batchFolderInput) batchFolderInput.value = "";
    };

    const createStatusRow = (file) => {
      const pathName = file.webkitRelativePath || file.name;
      const key = `${pathName}-${file.size}-${file.lastModified}`;
      const row = document.createElement("div");
      row.className = "status-row";
      row.dataset.filename = pathName;
      row.dataset.key = key;
      row.innerHTML = `
        <div class="status-name">
          <span class="status-icon" aria-hidden="true"></span>
          <span class="status-filename">${pathName}</span>
        </div>
        <div class="status-meta">${formatBytes(file.size)}</div>
        <div class="status-state">Queued</div>
        <div class="status-summary"></div>
        <div class="status-track">
          <div class="status-track-bar">
            <div class="status-progress"></div>
          </div>
          <span class="status-progress-text">0%</span>
        </div>
      `;
      batchStatus?.appendChild(row);
      return row;
    };

    const updateOverallProgress = () => {
      let loaded = 0;
      let total = 0;
      uploadState.forEach((entry) => {
        loaded += entry.loaded || 0;
        total += entry.total || 0;
      });
      const pct = total ? Math.round((loaded / total) * 100) : 0;
      if (batchProgress) batchProgress.style.width = `${pct}%`;
    };

    const getThresholdValue = () => {
      const thresholdInput = document.querySelector('input[name="threshold"]');
      if (!thresholdInput) return 0;
      const value = parseInt(thresholdInput.value, 10);
      return Number.isFinite(value) ? value : 0;
    };

    const setStatusIcon = (row, passed) => {
      const icon = row.querySelector(".status-icon");
      if (!icon) return;
      icon.classList.remove("pass", "fail");
      if (passed === true) icon.classList.add("pass");
      if (passed === false) icon.classList.add("fail");
    };

    const pollStatus = (taskId, row) => {
      const url = `${backendUrl}/analysis/status/${taskId}`;
      fetch(url, { credentials: "omit" })
        .then((resp) => resp.json())
        .then((data) => {
          const state = data.state || "PENDING";
          const stateEl = row.querySelector(".status-state");
          const summaryEl = row.querySelector(".status-summary");
          const progressEl = row.querySelector(".status-progress");
          const progressText = row.querySelector(".status-progress-text");
          if (stateEl) {
            if (state === "SUCCESS") stateEl.textContent = "Complete";
            else if (state === "FAILURE") stateEl.textContent = "Failed";
            else if (state === "STARTED") stateEl.textContent = "Running";
            else stateEl.textContent = "Queued";
          }
          if (typeof data.progress === "number") {
            const pct = Math.max(0, Math.min(100, data.progress));
            if (progressEl) progressEl.style.width = `${pct}%`;
            if (progressText) progressText.textContent = `${pct}%`;
          }

          if (state === "SUCCESS") {
            const score = Number(data?.result?.score);
            const threshold = getThresholdValue();
            const passed = Number.isFinite(score) ? score >= threshold : null;
            setStatusIcon(row, passed);
            if (summaryEl) summaryEl.textContent = data?.result?.summary || "";
            return;
          }
          if (state === "FAILURE") {
            setStatusIcon(row, false);
            if (summaryEl) summaryEl.textContent = "Failed to generate report.";
            return;
          }
          setTimeout(() => pollStatus(taskId, row), 2000);
        })
        .catch(() => {
          const stateEl = row.querySelector(".status-state");
          if (stateEl) stateEl.textContent = "Status error";
          setTimeout(() => pollStatus(taskId, row), 4000);
        });
    };

    const uploadFile = (file, row) =>
      new Promise((resolve) => {
        const request = new XMLHttpRequest();
        const formData = new FormData();
        formData.append("file", file, file.name);

        const aiModel = savedAiSettings?.ai_model || "";
        const temperature = savedAiSettings?.temperature || "";
        const threshold = savedAiSettings?.threshold || "";
        const companyName = document.querySelector('input[name="company_name"]')?.value || "";
        const role = document.querySelector('select[name="role"]')?.value || "";
        const experienceLevel = document.querySelector('input[name="experience_level"]')?.value || "";
        const jobDescription = document.querySelector('textarea[name="job_description"]')?.value || "";
        const jdPrompt = buildFinalPrompt();
        if (aiModel) formData.append("ai_model", aiModel);
        if (temperature) formData.append("temperature", temperature);
        if (threshold) formData.append("threshold", threshold);
        if (companyName) formData.append("company_name", companyName);
        if (role) formData.append("role", role);
        if (experienceLevel !== "") formData.append("experience_level", experienceLevel);
        if (jobDescription) formData.append("job_description", jobDescription);
        if (jdPrompt) formData.append("jd_prompt", jdPrompt);

        request.upload.addEventListener("progress", (event) => {
          if (!event.lengthComputable) return;
          uploadState.set(row.dataset.key, { loaded: event.loaded, total: event.total });
          updateOverallProgress();
          const meta = row.querySelector(".status-meta");
          if (meta) {
            const pct = Math.round((event.loaded / event.total) * 100);
            meta.textContent = `${pct}% uploaded`;
          }
        });

        request.onreadystatechange = () => {
          if (request.readyState !== 4) return;
          const stateEl = row.querySelector(".status-state");
          const summaryEl = row.querySelector(".status-summary");
          if (request.status >= 200 && request.status < 300) {
            const resp = JSON.parse(request.responseText || "{}");
            if (stateEl) stateEl.textContent = "Queued";
            if (resp.task_id) {
              row.dataset.taskId = resp.task_id;
              pollStatus(resp.task_id, row);
            }
          } else {
            if (stateEl) stateEl.textContent = "Upload failed";
            let detail = request.responseText || "";
            try {
              const parsed = JSON.parse(detail);
              detail = parsed.detail || parsed.message || detail;
            } catch (_) {
              // keep raw text
            }
            if (summaryEl) summaryEl.textContent = detail || "Upload failed.";
          }
          resolve();
        };

        request.open("POST", `${backendUrl}/analysis/async`);
        request.send(formData);
      });

    if (batchRun) {
      batchRun.addEventListener("click", async () => {
        if (settingsDirty) {
          if (aiSettingsStatus) aiSettingsStatus.textContent = "Save settings first";
          return;
        }
        const files = collectFiles().filter((file) => file.name.toLowerCase().endsWith(".pdf"));
        if (!files.length) {
          alert("Select at least one PDF file to upload.");
          return;
        }

        batchRun.classList.add("is-loading");
        batchRun.disabled = true;
        const label = batchRun.querySelector(".btn-label");
        const loadingText = batchRun.getAttribute("data-loading-text");
        if (label && loadingText) label.textContent = loadingText;

        files.forEach((file) => {
          const pathName = file.webkitRelativePath || file.name;
          const key = `${pathName}-${file.size}-${file.lastModified}`;
          uploadState.set(key, { loaded: 0, total: file.size });
        });
        updateOverallProgress();

        const uploads = files.map((file) => {
          const row = createStatusRow(file);
          return uploadFile(file, row);
        });
        await Promise.all(uploads);

        batchRun.classList.remove("is-loading");
        batchRun.disabled = false;
        if (label) label.textContent = "Run Batch";
      });
    }

    if (batchClear) {
      batchClear.addEventListener("click", () => resetBatchUI());
    }

    const roleEl = document.querySelector('select[name="role"]');
    const jobDescriptionEl = document.querySelector('textarea[name="job_description"]');
    const jdPromptEl = document.querySelector('textarea[name="jd_prompt"]');
    const jdPromptPreview = document.getElementById("jdPromptPreview");

    const buildFinalPrompt = () => {
      const role = roleEl?.value || "";
      const jd = jobDescriptionEl?.value || "";
      const userPrompt = jdPromptEl?.value || "";
      const parts = [];
      if (role) parts.push(`Role: ${role}`);
      if (userPrompt) parts.push(`Skills:\n${userPrompt}`);
      if (jd) parts.push(`Job Description:\n${jd}`);
      return parts.join("\n\n");
    };

    const renderFinalPrompt = () => {
      const rendered = buildFinalPrompt();
      if (jdPromptPreview) {
        jdPromptPreview.textContent = rendered ? `Preview:\n${rendered}` : "";
      }
    };

    if (roleEl) roleEl.addEventListener("change", renderFinalPrompt);
    if (jobDescriptionEl) jobDescriptionEl.addEventListener("input", renderFinalPrompt);
    if (jdPromptEl) jdPromptEl.addEventListener("input", renderFinalPrompt);

    renderFinalPrompt();

    if (saveAiSettingsButton) {
      saveAiSettingsButton.addEventListener("click", () => {
        saveAiSettingsButton.classList.add("is-loading");
        saveAiSettingsButton.setAttribute("aria-busy", "true");
        const label = saveAiSettingsButton.querySelector(".btn-label");
        const loadingText = saveAiSettingsButton.getAttribute("data-loading-text");
        if (label && loadingText) label.textContent = loadingText;
        const provider = document.querySelector('select[name="provider"]')?.value || "groq";
        const aiModel = document.querySelector('select[name="ai_model"]')?.value || "";
        const temperature = document.querySelector('input[name="temperature"]')?.value || "";
        const threshold = document.querySelector('input[name="threshold"]')?.value || "";
        savedAiSettings = { provider, ai_model: aiModel, temperature, threshold };
        setTimeout(() => {
          saveAiSettingsButton.classList.remove("is-loading");
          saveAiSettingsButton.removeAttribute("aria-busy");
          if (label) label.textContent = "Save AI Settings";
          markSettingsSaved();
        }, 400);
      });
    }

    if (form) {
      form.addEventListener('submit', (e) => {
        if (settingsDirty) {
          e.preventDefault();
          if (aiSettingsStatus) aiSettingsStatus.textContent = "Save settings first";
          return;
        }
        const button = form.querySelector('button[type="submit"]');
        if (button) {
          button.classList.add('is-loading');
          button.disabled = true;
          const label = button.querySelector('.btn-label');
          const loadingText = button.getAttribute('data-loading-text');
          if (label && loadingText) {
            label.textContent = loadingText;
          }
        }
        const aiModelInput = form.querySelector('select[name="ai_model"]');
        const providerInput = form.querySelector('select[name="provider"]');
        const temperatureInput = form.querySelector('input[name="temperature"]');
        const thresholdInputLocal = form.querySelector('input[name="threshold"]');
        if (providerInput) providerInput.value = savedAiSettings?.provider || "groq";
        if (aiModelInput) aiModelInput.value = savedAiSettings?.ai_model || "";
        if (temperatureInput) temperatureInput.value = savedAiSettings?.temperature || "";
        if (thresholdInputLocal) thresholdInputLocal.value = savedAiSettings?.threshold || "";
        if (jdPromptEl) jdPromptEl.value = buildFinalPrompt();
      });
    }

    if (modelSelect) modelSelect.addEventListener("change", markSettingsDirty);
    if (tempInputEl) tempInputEl.addEventListener("input", markSettingsDirty);
    if (thresholdInputEl) thresholdInputEl.addEventListener("input", markSettingsDirty);

    // Initialize saved settings from current UI state
    const initProvider = providerSelect?.value || "groq";
    const initModel = modelSelect?.value || "";
    const initTemp = tempInputEl?.value || "";
    const initThreshold = thresholdInputEl?.value || "";
    savedAiSettings = { provider: initProvider, ai_model: initModel, temperature: initTemp, threshold: initThreshold };
    markSettingsSaved();
  </script>
</body>
</html>
